<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>YOLOv8 Real-Time Object Detection</title>
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.19.0/dist/ort.min.js"></script>
  <style>
    *, ::before, ::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      min-height: 100vh; display: flex; flex-direction: column; align-items: center;
      justify-content: flex-start; padding: 60px 20px 40px 20px; color: #4a4a4a;
      background: linear-gradient(135deg, #f0f4f8, #d9e2ec);
      overflow-x: hidden; overflow-y: auto; -webkit-overflow-scrolling: touch;
    }
    h1 {
      font-size: 2.8rem; font-weight: 700; color: #334e68; margin-bottom: 1rem; text-align: center;
      letter-spacing: 0.12em; text-transform: uppercase;
    }
    .controls { text-align: center; margin-bottom: 24px; }
    button {
      background: linear-gradient(135deg, #86c8bc, #52b69a); color: #f0f4f8; border: none;
      border-radius: 999px; padding: 10px 24px; font-size: 1rem; font-weight: 600;
      margin: 0 6px; cursor: pointer;
    }
    .main-content {
      display: flex; flex-direction: row; gap: 28px; justify-content: center;
      align-items: flex-start; padding: 0 30px; width: 100%; max-width: 960px;
    }
    .box {
      flex: 1 1 390px; aspect-ratio: 1/1; min-width: 300px; position: relative;
      margin-bottom: 10px; border-radius: 20px; background: #000;
      display: flex; align-items: center; justify-content: center; overflow: hidden;
    }
    video, canvas {
      width: 100%; height: 100%; border-radius: 18px; object-fit: cover;
      position: relative; z-index: 1;
    }
    .summary-wrapper {
      margin-top: 16px; width: 100%; max-width: 960px;
      background: rgba(255,255,255,0.9); border-radius: 16px;
      padding: 16px 20px;
    }
    .summary-header { font-weight: 700; font-size: 1.1rem; margin-bottom: 4px; }
    .summary-count { font-weight: 600; color: #1f6f8b; margin-bottom: 8px; }
    .summary-list { font-size: 0.95rem; max-height: 140px; overflow-y: auto; }
    .summary-item { margin-bottom: 3px; }
    footer { margin-top: 24px; text-align: center; font-size: 0.92rem; color: #6e7e85; }
    @media (max-width: 900px) {
      .main-content { flex-direction: column; align-items: center; gap: 20px; padding: 0 10px; }
      .box { max-width: 94vw; aspect-ratio: 4/3; flex: none; }
    }
  </style>
</head>
<body>
  <h1>REAL-TIME OBJECT DETECTION</h1>

  <div class="controls">
    <button id="start">Start Detection</button>
    <button id="stop">Stop Detection</button>
  </div>

  <div class="main-content">
    <div class="box"><video id="video" autoplay playsinline muted></video></div>
    <div class="box"><canvas id="canvas"></canvas></div>
  </div>

  <div class="summary-wrapper">
    <div class="summary-header">Detection Summary</div>
    <div id="summary-count" class="summary-count">No objects detected yet.</div>
    <div id="summary-list" class="summary-list"></div>
  </div>

  <footer>&copy; 2025 YOLOv8 Detection Demo</footer>

  <script>
    const startBtn = document.getElementById('start');
    const stopBtn = document.getElementById('stop');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    const summaryCountEl = document.getElementById('summary-count');
    const summaryListEl = document.getElementById('summary-list');

    let stream = null, running = false, rafId = null, session = null, isDetecting = false;

    const COCOCLASSES = ['person','bicycle','car','motorcycle','airplane','bus','train','truck','boat','traffic light',
      'fire hydrant','stop sign','parking meter','bench','bird','cat','dog','horse','sheep','cow',
      'elephant','bear','zebra','giraffe','backpack','umbrella','handbag','tie','suitcase','frisbee',
      'skis','snowboard','sports ball','kite','baseball bat','baseball glove','skateboard','surfboard',
      'tennis racket','bottle','wine glass','cup','fork','knife','spoon','bowl','banana','apple',
      'sandwich','orange','broccoli','carrot','hot dog','pizza','donut','cake','chair','couch',
      'potted plant','bed','dining table','toilet','tv','laptop','mouse','remote','keyboard','cell phone',
      'microwave','oven','toaster','sink','refrigerator','book','clock','vase','scissors','teddy bear',
      'hair drier','toothbrush'];

    const OBJECT_DESCRIPTIONS = { /* same mapping as previous message */ };

    async function initModel() {
      if (!session) {
        session = await ort.InferenceSession.create('/static/yolov8n.onnx', {
          executionProviders: ['wasm']
        });
        console.log('YOLOv8 model loaded');
      }
    }

    function preprocessFrame() {
      const tmp = document.createElement('canvas');
      tmp.width = tmp.height = 640;
      const tctx = tmp.getContext('2d');
      tctx.drawImage(video, 0, 0, 640, 640);
      const { data } = tctx.getImageData(0, 0, 640, 640);
      const input = new Float32Array(3 * 640 * 640);
      for (let i = 0, j = 0; i < data.length; i += 4, j++) {
        input[j] = data[i] / 255;
        input[j + 640*640] = data[i+1] / 255;
        input[j + 2*640*640] = data[i+2] / 255;
      }
      return input;
    }

    async function detect() {
      if (isDetecting || !session) return [];
      isDetecting = true;
      try {
        const tensor = new ort.Tensor('float32', preprocessFrame(), [1,3,640,640]);
        const outMap = await session.run({ images: tensor });
        const key = Object.keys(outMap)[0];
        return postprocess(outMap[key]);
      } catch (e) {
        console.error('detect error', e);
        return [];
      } finally { isDetecting = false; }
    }

    function postprocess(out) {
      const numClasses = COCOCLASSES.length;
      const dims = out.dims;
      const data = out.data;
      const confT = 0.25, iouT = 0.5;
      const dets = [];

      if (dims[1] === 84 && dims[2] === 8400) {
        const n = 8400;
        for (let i=0;i<n;i++) {
          const cx = data[i], cy = data[n+i], w = data[2*n+i], h = data[3*n+i];
          let best=0, id=-1;
          for (let c=0;c<numClasses;c++) {
            const s = data[4*n + c*n + i];
            if (s>best){best=s;id=c;}
          }
          pushDet(dets,cx,cy,w,h,best,id,confT);
        }
      } else if (dims[1] === 8400 && dims[2] === 84) {
        const n = 8400;
        for (let i=0;i<n;i++) {
          const off = i*84;
          const cx = data[off], cy = data[off+1], w = data[off+2], h = data[off+3];
          let best=0,id=-1;
          for (let c=0;c<numClasses;c++) {
            const s = data[off+4+c];
            if (s>best){best=s;id=c;}
          }
          pushDet(dets,cx,cy,w,h,best,id,confT);
        }
      }

      dets.sort((a,b)=>b.score-a.score);
      const res=[];
      for (const d of dets){
        if(res.every(r=>iou(r,d)<iouT)) res.push(d);
      }
      return res.slice(0,20);
    }

    function pushDet(list,cx,cy,w,h,score,classId,thr){
      if(score<thr || classId<0) return;
      const MODEL_W=640, MODEL_H=640;
      const scaleX = canvas.width / MODEL_W;
      const scaleY = canvas.height / MODEL_H;
      const x1=(cx-w/2)*scaleX, y1=(cy-h/2)*scaleY;
      const x2=(cx+w/2)*scaleX, y2=(cy+h/2)*scaleY;
      list.push({x1,y1,x2,y2,label:COCOCLASSES[classId],score,
        widthPx:Math.round(x2-x1),heightPx:Math.round(y2-y1)});
    }

    function iou(a,b){
      const x1=Math.max(a.x1,b.x1), y1=Math.max(a.y1,b.y1);
      const x2=Math.min(a.x2,b.x2), y2=Math.min(a.y2,b.y2);
      const inter=Math.max(0,x2-x1)*Math.max(0,y2-y1);
      const areaA=(a.x2-a.x1)*(a.y2-a.y1);
      const areaB=(b.x2-b.x1)*(b.y2-b.y1);
      return inter===0?0:inter/(areaA+areaB-inter+1e-6);
    }

    async function startCamera(){
      const constraints={video:true,audio:false};
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;
      await new Promise(res => video.onloadedmetadata = res);
      await video.play();
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      await initModel();
    }

    async function loop(){
      if(!running) return;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      const dets = await detect();
      const count = dets.length;

      // summary
      if(!count){
        summaryCountEl.textContent='No objects detected.';
        summaryListEl.innerHTML='';
      } else {
        summaryCountEl.textContent=`${count} object(s) detected.`;
        const agg={};
        dets.forEach(d=>agg[d.label]=(agg[d.label]||0)+1);
        summaryListEl.innerHTML = Object.entries(agg).map(([label,c])=>{
          const desc = OBJECT_DESCRIPTIONS[label] || 'Detected object';
          return `<div class="summary-item">${c}× <strong>${label}</strong> — ${desc}</div>`;
        }).join('');
      }

      // boxes
      dets.forEach(d=>{
        const {x1,y1,x2,y2,label,score,widthPx,heightPx}=d;
        const desc = OBJECT_DESCRIPTIONS[label] || 'Detected object';

        ctx.lineWidth=3;
        ctx.strokeStyle='rgba(82,182,154,0.9)';
        ctx.fillStyle='rgba(82,182,154,0.25)';
        ctx.fillRect(x1,y1,x2-x1,y2-y1);
        ctx.strokeRect(x1,y1,x2-x1,y2-y1);

        const labelText = `${label} ${(score*100).toFixed(1)}%`;
        ctx.font='16px Segoe UI';
        const labelWidth = ctx.measureText(labelText).width+10;
        ctx.fillStyle='rgba(82,182,154,0.95)';
        ctx.fillRect(x1,y1-40,labelWidth,20);
        ctx.fillStyle='#fff';
        ctx.fillText(labelText,x1+5,y1-25);

        ctx.font='13px Segoe UI';
        const descWidth = ctx.measureText(desc).width+10;
        ctx.fillStyle='rgba(51,110,123,0.95)';
        ctx.fillRect(x1,y1-20,Math.max(labelWidth,descWidth),18);
        ctx.fillStyle='#f0f8ff';
        ctx.fillText(desc,x1+5,y1-7);

        const sizeText = `${widthPx}×${heightPx}px`;
        ctx.font='12px Segoe UI';
        const sizeWidth = ctx.measureText(sizeText).width+8;
        ctx.fillStyle='rgba(82,182,154,0.9)';
        ctx.fillRect(x1,y2+2,sizeWidth,16);
        ctx.fillStyle='#fff';
        ctx.fillText(sizeText,x1+4,y2+14);
      });

      rafId = requestAnimationFrame(loop);
    }

    startBtn.onclick = async ()=>{
      if(running) return;
      try{
        await startCamera();
        running=true;
        loop();
      }catch(e){
        console.error(e);
        alert('Camera error: '+e.message);
      }
    };

    stopBtn.onclick = ()=>{
      running=false;
      if(rafId) cancelAnimationFrame(rafId);
      if(stream){
        stream.getTracks().forEach(t=>t.stop());
        stream=null;
      }
      ctx.clearRect(0,0,canvas.width,canvas.height);
      summaryCountEl.textContent='Detection stopped.';
      summaryListEl.innerHTML='';
    };
  </script>
</body>
</html>
